<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} - K8s Universal Inspector</title>
    <link rel="stylesheet" href="/style.css{{ .CacheBuster }}">
</head>
<body>

    {{ template "sidebar" . }}

    <main class="main-content">
        <h1>{{ .DeploymentName }}</h1>
        
        {{ if .ErrorLogs }}
        <div class="errors">
            <h2>Errors</h2>
            <ul>{{ range .ErrorLogs }} <li>{{ . }}</li> {{ end }}</ul>
        </div>
        {{ end }}

        <div class="tabs-container">
            {{ range $index, $cluster := .ClusterNames }}
                <button class="tab-btn {{ if eq $index 0 }}active{{ end }}" 
                        onclick="openTab('{{ $cluster }}', this)">
                    {{ $cluster }}
                </button>
            {{ end }}
        </div>

        {{ range $index, $cluster := .ClusterNames }}
            {{ $overview := index $.Overviews $cluster }}
            {{ $nsMap := index $.Pods $cluster }}

            {{ $details := "" }}
            {{ $compName := "" }}
            {{ range $name, $data := $overview }}
                {{ $compName = $name }}
                {{ $details = $data }}
                {{ break }} {{ end }}
            
            <div id="tab-{{ $cluster }}" class="deployment-content {{ if eq $index 0 }}active{{ end }}">
                
                {{ if $details }}

                <div class="ns-bar">
                    <span class="ns-label">Namespace:</span>
                    <div class="ns-pills">
                        {{ $firstNs := true }}
                        {{ range $ns, $pods := $nsMap }}
                            <button class="ns-btn {{ if $firstNs }}active{{ end }}" 
                                    onclick="switchNamespace('{{ $cluster }}', '{{ $ns }}', this)">
                                {{ $ns }}
                            </button>
                            {{ $firstNs = false }}
                        {{ end }}
                        
                        {{ if not $nsMap }}
                            <span style="color:#666; font-style:italic; font-size:0.9rem;">No pods found</span>
                        {{ end }}
                    </div>
                </div>

                <div class="detail-grid">
                    
                    <div class="detail-main">
                        
                        <div class="container" style="margin-top:0;">
                            <h2>ReplicaSets / History</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Revision</th>
                                        <th>ReplicaSet Name</th>
                                        <th>Replicas</th>
                                        <th>Change Cause</th>
                                        <th>Age</th>
                                        <th>Images</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{ range $details.RolloutHistory }}
                                    <tr {{ if .IsActive }}style="background: rgba(16, 185, 129, 0.05); border-left: 2px solid #10b981;"{{ end }}>
                                        <td>
                                            <span class="cluster-tag">#{{ .Revision }}</span>
                                            {{ if .IsActive }}
                                                <span class="status status-ready" style="font-size:0.7em; margin-left:5px;">ACTIVE</span>
                                            {{ end }}
                                        </td>
                                        <td style="white-space: normal; word-break: break-all; max-width: 250px;">
                                            <a href="{{ MakeURL $.QueryString "/replicaset/detail" "name" .Name "namespace" $compName "cluster_name" $cluster }}" class="deployment-link">
                                                {{ .Name }}
                                            </a>
                                        </td>
                                        <td>{{ .Replicas }}</td>
                                        <td style="white-space: normal; max-width: 200px; font-style: italic;">
                                            {{ if ne .ChangeCause "<none>" }}{{ .ChangeCause }}{{ else }}<span style="color:#6b7280">-</span>{{ end }}
                                        </td>
                                        <td>{{ .Age }}</td>
                                        <td style="white-space: normal; word-break: break-all; max-width: 350px;">
                                            {{ range .Images }} <span class="image-tag" style="font-size:0.8rem;">{{ . }}</span> {{ end }}
                                        </td>
                                    </tr>
                                    {{ else }}
                                    <tr><td colspan="6" class="no-data">No history found.</td></tr>
                                    {{ end }}
                                </tbody>
                            </table>
                        </div>

                        <div class="container">
                            <h2>Pods</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Ready</th>
                                        <th>Status</th>
                                        <th>Restarts</th>
                                        <th>Node</th>
                                    </tr>
                                </thead>
                                
                                {{ $firstNsBody := true }}
                                {{ range $ns, $podList := $nsMap }}
                                    <tbody id="pods-{{ $cluster }}-{{ $ns }}" class="pods-tbody {{ if $firstNsBody }}active{{ end }}">
                                        {{ range $podList }}
                                        <tr>
                                            <td>
                                                <a href="{{ MakeURL $.QueryString "/pod/detail" "name" .Name "namespace" .Namespace "cluster_name" .Cluster }}" class="deployment-link">{{ .Name }}</a>
                                            </td>
                                            <td>{{ .Ready }}</td>
                                            <td><span class="status status-{{ .Status | ToLower }}">{{ .Status }}</span></td>
                                            <td>{{ .Restarts }}</td>
                                            <td><a href="{{ MakeURL $.QueryString "/node/detail" "name" .Node "cluster_name" .Cluster }}" class="deployment-link">{{ .Node }}</a></td>
                                        </tr>
                                        {{ end }}
                                    </tbody>
                                    {{ $firstNsBody = false }}
                                {{ else }}
                                    <tbody><tr><td colspan="5" class="no-data">No pods found in this cluster.</td></tr></tbody>
                                {{ end }}
                            </table>
                        </div>
                    </div>

                    <div class="detail-sidebar">
                        
                        <div class="overview-box">
                            <h2>Rollout Status</h2>
                            <div style="padding: 1.5rem;">
                                {{ if $details.RolloutStatus.IsComplete }}
                                    <div style="color: #10b981; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>✔</span> Successfully rolled out
                                    </div>
                                {{ else }}
                                    <div style="color: #f59e0b; font-weight: 600; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem; animation: pulse 2s infinite;">
                                        <span>⟳</span> Rolling out...
                                    </div>
                                    <div style="margin-top: 0.75rem; font-size: 0.9rem; line-height: 1.4; color: #d1d5db; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                        {{ $details.RolloutStatus.Message }}
                                    </div>
                                {{ end }}
                            </div>
                        </div>

                        <div class="overview-box">
                            <h2>Overview</h2>
                            <ul class="overview-list">
                                <li><strong>Component</strong> <span>{{ $compName }}</span></li>
                                <li><strong>Replicas</strong> <span>{{ $details.Status }} (Ready/Total)</span></li>
                                <li><strong>Strategy</strong> <span class="strategy-tag">{{ $details.Strategy }}</span></li>
                                <li><strong>Selector</strong> <span style="font-family: monospace; font-size: 0.85rem;">{{ $details.Selector }}</span></li>
                            </ul>
                        </div>

                        <div class="overview-box">
                            <h2>Images</h2>
                            <div style="padding: 1rem 1.5rem;">
                                {{ range $details.Images }}
                                    <div style="margin-bottom: 0.5rem;"><span class="image-tag">{{ . }}</span></div>
                                {{ end }}
                            </div>
                        </div>

                        <div class="overview-box">
                            <h2>Conditions</h2>
                            <div class="key-value-list" style="padding: 1rem 1.5rem;">
                                {{ range $details.Conditions }}
                                    <div style="margin-bottom:0.5rem;"><span class="data-value">{{ . }}</span></div>
                                {{ end }}
                            </div>
                        </div>

                    </div>
                </div>

                {{ else }}
                    <div class="no-data">No deployment details available for this cluster.</div>
                {{ end }} </div>
        {{ end }}
    </main>

    <script>
        function openTab(clusterName, btn) {
            document.querySelectorAll('.deployment-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + clusterName).classList.add('active');
            btn.classList.add('active');
        }

        function switchNamespace(cluster, ns, btn) {
            const activeTab = document.getElementById('tab-' + cluster);
            
            // Toggle Pills
            activeTab.querySelectorAll('.ns-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Toggle Pod Tables
            activeTab.querySelectorAll('.pods-tbody').forEach(body => body.classList.remove('active'));
            const targetId = 'pods-' + cluster + '-' + ns;
            const targetBody = document.getElementById(targetId);
            if(targetBody) targetBody.classList.add('active');
        }
    </script>
</body>
</html>