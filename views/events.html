<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} - K8s Universal Inspector</title>
    <link rel="stylesheet" href="/style.css{{ .CacheBuster }}">
</head>
<body>

    {{ template "sidebar" . }}

    <main class="main-content">
        <h1>{{ .Title }} <span class="title-count">({{ .TotalEvents }})</span></h1>

        <div class="stats-container three-col">
            <div class="stat-widget">
                <h3>Warning Events by Cluster</h3>
                <div class="chart-container">
                    <div class="stacked-bar-container">
                        {{ $colors := ColorSlice }}
                        {{ $totalClusters := 0 }}{{ range .ClusterStats }}{{ $totalClusters = add $totalClusters .Count }}{{ end }}
                        {{ range $i, $stat := .ClusterStats }}
                            {{ $color := index $colors (mod $i 10) }}
                            <div class="bar-segment" style="width: {{ printf "%.2f" (fdiv .Count $totalClusters | mulf 100.0) }}%; background-color: {{ $color }};" title="{{ .Name }}: {{ .Count }}"></div>
                        {{ end }}
                    </div>
                    <div class="chart-legend">
                        {{ range $i, $stat := .ClusterStats }}
                        <div class="legend-item"><span class="legend-color" style="background-color: {{ index $colors (mod $i 10) }};"></span>{{ .Name }} ({{ .Count }})</div>
                        {{ end }}
                    </div>
                </div>
            </div>

            <div class="stat-widget"> 
                <h3>Top Namespaces (Warnings)</h3>
                <div class="chart-container">
                    <div class="stacked-bar-container">
                        {{ $colors := ColorSlice }}
                        {{ $totalNS := 0 }}{{ range .NamespaceStats }}{{ $totalNS = add $totalNS .Count }}{{ end }}
                        {{ range $i, $stat := .NamespaceStats }}
                            {{ $color := index $colors (mod $i 10) }}
                            <div class="bar-segment" style="width: {{ printf "%.2f" (fdiv .Count $totalNS | mulf 100.0) }}%; background-color: {{ $color }};" title="{{ .Name }}: {{ .Count }}"></div>
                        {{ end }}
                    </div>
                    <div class="chart-legend">
                        {{ range $i, $stat := .NamespaceStats }}
                        <div class="legend-item"><span class="legend-color" style="background-color: {{ index $colors (mod $i 10) }};"></span>{{ .Name }} ({{ .Count }})</div>
                        {{ end }}
                    </div>
                </div>
            </div>

            <div class="stat-widget">
                <h3>Top Reasons</h3>
                <div class="chart-container">
                    <div class="stacked-bar-container">
                        {{ $colors := ColorSlice }}
                        {{ $totalReasons := 0 }}{{ range .ReasonStats }}{{ $totalReasons = add $totalReasons .Count }}{{ end }}
                        {{ range $i, $stat := .ReasonStats }}
                            {{ $color := index $colors (mod $i 10) }}
                            <div class="bar-segment" style="width: {{ printf "%.2f" (fdiv .Count $totalReasons | mulf 100.0) }}%; background-color: {{ $color }};" title="{{ .Reason }}: {{ .Count }}"></div>
                        {{ end }}
                    </div>
                    <div class="chart-legend">
                        {{ range $i, $stat := .ReasonStats }}
                        <div class="legend-item"><span class="legend-color" style="background-color: {{ index $colors (mod $i 10) }};"></span>{{ .Reason }} ({{ .Count }})</div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        <div class="container" style="overflow-x: auto;">
            <h2>Warning Heatmap (Cluster vs Namespace)</h2>
            <div class="heatmap-container">
                <table class="heatmap">
                    <thead>
                        <tr>
                            <th>Cluster \ Namespace</th>
                            {{ range .HeatmapNamespaces }}<th>{{ . }}</th>{{ end }}
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .HeatmapRows }}
                        <tr>
                            <th>{{ .ClusterName }}</th>
                            {{ range .Cells }}
                            <td class="{{ .Level }}">
                                <span class="heat-cell">
                                    {{ if gt .Count 0 }}{{ .Count }}{{ else }}-{{ end }}
                                </span>
                                {{ if gt .Count 0 }}
                                <div class="heatmap-tooltip">
                                    <strong>{{ .Count }} Warnings</strong><br>
                                    Top: {{ .TopReason }} ({{ .TopReasonCount }})
                                </div>
                                {{ end }}
                            </td>
                            {{ end }}
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </div>
        </div>

        {{ if .ErrorLogs }}
        <div class="errors">
            <h2>Connection Errors</h2>
            <ul>{{ range .ErrorLogs }} <li>{{ . }}</li> {{ end }}</ul>
        </div>
        {{ end }}

        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="filterTable('searchInput', 'mainTable')" placeholder="Search events...">
        </div>

        <div class="container">
            <h2>Recent Events (Last 100)</h2>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th class="sortable-header" data-sort-type="string">Time</th>
                        <th class="sortable-header" data-sort-type="string">Type</th>
                        <th class="sortable-header" data-sort-type="string">Reason</th>
                        <th class="sortable-header" data-sort-type="string">Object</th>
                        <th>Message</th>
                        <th class="sortable-header" data-sort-type="number">Count</th>
                        <th class="sortable-header" data-sort-type="string">Cluster</th>
                        <th class="sortable-header" data-sort-type="string">Namespace</th>
                    </tr>
                </thead>
                <tbody>
                    {{ range .RecentEvents }}
                    <tr>
                        <td>{{ .LastSeen }}</td>
                        <td class="{{ if eq .Type "Warning" }}event-warning{{ else }}event-normal{{ end }}">{{ .Type }}</td>
                        <td>{{ .Reason }}</td>
                        <td>{{ .Object }}</td>
                        <td style="white-space: normal; max-width: 400px;">{{ .Message }}</td>
                        <td>{{ .Count }}</td>
                        <td class="cluster-name">{{ .Cluster }}</td>
                        <td>
                            {{ if .Namespace }}
                            <a href="{{ MakeURL $.QueryString "/namespace/detail" "name" .Namespace }}" class="deployment-link">{{ .Namespace }}</a>
                            {{ else }}-{{ end }}
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </div>
    </main>

    <script src="/static/js/table_utils.js"></script>
</body>
</html>