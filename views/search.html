<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - K8s Universal Inspector</title>
    <link rel="stylesheet" href="/style.css{{ .CacheBuster }}">
</head>
<body>

    {{ template "sidebar" . }}

    <main class="main-content">
        <h1>Global Search</h1>

        <div class="search-container" style="max-width: 800px;">
            <form id="searchForm" style="display: flex; gap: 1rem;">
                <input type="text" id="queryInput" name="q" value="{{ .Query }}" class="input-dark" placeholder="Enter regex (e.g. ^prod-.*-db$)..." autofocus>
                <button type="submit" class="btn btn-primary" id="searchBtn">Search</button>
            </form>
        </div>

        <div id="statusContainer" style="margin: 0 auto 1.5rem auto; max-width: 1600px; display: none;">
            <div style="background: #1F2937; padding: 1rem 1.5rem; border-radius: 8px; border: 1px solid #374151; display: flex; align-items: center; justify-content: space-between;">
                <span id="statusText" style="color: #9ca3af; font-family: 'IBM Plex Mono', monospace;">Searching...</span>
                <div id="loader" style="width: 20px; height: 20px; border: 3px solid #374151; border-top: 3px solid #22d3ee; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>

        <div class="container">
            <h2>Results <span id="resultCount" class="title-count">(0)</span></h2>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th class="sortable-header" data-sort-type="string">Kind</th>
                        <th class="sortable-header" data-sort-type="string">Name</th>
                        <th class="sortable-header" data-sort-type="string">Namespace</th>
                        <th class="sortable-header" data-sort-type="string">Cluster</th>
                        <th>Matched Property</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <tr id="emptyRow"><td colspan="5" class="no-data">Enter a query to start searching.</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="/static/js/table_utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('searchForm');
            const queryInput = document.getElementById('queryInput');
            const resultsBody = document.getElementById('resultsBody');
            const statusContainer = document.getElementById('statusContainer');
            const statusText = document.getElementById('statusText');
            const loader = document.getElementById('loader');
            const resultCountSpan = document.getElementById('resultCount');
            const emptyRow = document.getElementById('emptyRow');

            // If page loaded with a query param (e.g. from a link), auto-search
            const urlParams = new URLSearchParams(window.location.search);
            const initialQuery = urlParams.get('q');
            if (initialQuery) {
                queryInput.value = initialQuery;
                performSearch(initialQuery);
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const query = queryInput.value.trim();
                if (!query) return;
                
                // Update URL without reloading
                const url = new URL(window.location);
                url.searchParams.set('q', query);
                window.history.pushState({}, '', url);
                
                performSearch(query);
            });

            function performSearch(query) {
                // Reset UI
                resultsBody.innerHTML = '';
                statusContainer.style.display = 'block';
                statusText.textContent = 'Starting search...';
                loader.style.display = 'block';
                resultCountSpan.textContent = '(0)';
                
                // Group requests to prevent browser/server exhaustion
                const resourceGroups = [
                    // Group 1: Core Identifiers (Fastest)
                    "cluster,namespace,node",
                    // Group 2: Workloads (Heaviest)
                    "deployment,pod,replicaset,daemonset,statefulset",
                    // Group 3: Network
                    "service,ingress",
                    // Group 4: Config & Storage
                    "configmap,secret,serviceaccount,pv,pvc"
                ];
                
                let activeRequests = resourceGroups.length;
                let totalResults = 0;

                resourceGroups.forEach(group => {
                    // Send comma-separated list to backend
                    const url = `/api/search?q=${encodeURIComponent(query)}&type=${group}{{ .QueryString }}`;
                    
                    fetch(url)
                        .then(response => {
                            if (!response.ok) throw new Error("Network error");
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.length > 0) {
                                totalResults += data.length;
                                resultCountSpan.textContent = `(${totalResults})`;
                                appendRows(data);
                            }
                        })
                        .catch(err => {
                            console.error(`Error fetching group ${group}:`, err);
                        })
                        .finally(() => {
                            activeRequests--;
                            // Update status text
                            if (activeRequests > 0) {
                                const percent = Math.round(((4 - activeRequests) / 4) * 100);
                                statusText.textContent = `Searching... ${percent}%`;
                            } else {
                                finishSearch(totalResults);
                            }
                        });
                });
            }

            function appendRows(data) {
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Kind Column
                    const kindCell = document.createElement('td');
                    kindCell.innerHTML = `<span class="strategy-tag">${item.Type}</span>`;
                    row.appendChild(kindCell);

                    // Name Column (Link logic)
                    const nameCell = document.createElement('td');
                    if (item.URL && item.URL !== "#") {
                        nameCell.innerHTML = `<a href="${item.URL}{{ .QueryString }}" class="deployment-link">${item.Name}</a>`;
                    } else {
                        nameCell.textContent = item.Name;
                    }
                    row.appendChild(nameCell);

                    // Namespace Column (Link logic - UPDATED)
                    const nsCell = document.createElement('td');
                    if (item.Namespace) {
                        // Create link to namespace detail
                        const nsUrl = `/namespace/detail?name=${encodeURIComponent(item.Namespace)}{{ .QueryString }}`;
                        nsCell.innerHTML = `<a href="${nsUrl}" class="deployment-link">${item.Namespace}</a>`;
                    } else {
                        nsCell.textContent = '-';
                    }
                    row.appendChild(nsCell);

                    // Cluster
                    const clusterCell = document.createElement('td');
                    clusterCell.className = 'cluster-name';
                    clusterCell.textContent = item.Cluster;
                    row.appendChild(clusterCell);

                    // Matches
                    const matchCell = document.createElement('td');
                    if (item.Matches) {
                        item.Matches.forEach(m => {
                            const div = document.createElement('div');
                            div.style.fontSize = '0.85rem';
                            div.style.color = '#9ca3af';
                            div.textContent = `${m.Field}: ${m.Value}`;
                            matchCell.appendChild(div);
                        });
                    }
                    row.appendChild(matchCell);

                    resultsBody.appendChild(row);
                });
            }

            function finishSearch(count) {
                loader.style.display = 'none';
                if (count === 0) {
                    statusText.textContent = 'Search complete. No matches found.';
                    resultsBody.innerHTML = '<tr><td colspan="5" class="no-data">No matches found.</td></tr>';
                } else {
                    statusText.textContent = `Search complete. Found ${count} matches.`;
                }
            }
        });
    </script>

    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</body>
</html>