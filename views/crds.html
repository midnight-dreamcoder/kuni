<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }} - K8s Universal Inspector</title>
    <link rel="stylesheet" href="/style.css{{ .CacheBuster }}">
    <style>
        .stats-container, .container, .search-container, .errors { max-width: 1600px; }
        .stats-container { grid-template-columns: 1fr 1fr; align-items: flex-start; }
        .stat-widget { padding: 0; }
        .stat-widget h3 { padding: 1rem 1.5rem; }
        .chart-container { padding: 1.5rem; }
        .stacked-bar-container { display: flex; width: 100%; height: 30px; border-radius: 6px; overflow: hidden; background: #374151; border: 1px solid #374151; margin-bottom: 1.5rem; }
        .bar-segment { height: 100%; transition: width 0.3s ease-out; box-shadow: 0 0 10px 0px; cursor: help; }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; font-family: 'IBM Plex Mono', monospace; font-size: 0.9rem; color: #9ca3af; }
        .legend-item { display: flex; align-items: center; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; margin-right: 8px; }
        .bar-chart-list .bar-label-other { font-weight: 700; font-style: italic; color: #9ca3af; }
        #mainTable th, #mainTable td { white-space: normal !important; }
        #mainTable .col-name, #mainTable .col-group { word-break: break-all; }
    </style>
</head>
<body>
    {{ template "sidebar" . }}
    <main class="main-content">
        <h1>{{ .Title }} <span class="title-count">({{ .TotalCRDs }})</span></h1>

        <div class="stats-container" style="max-width: 1600px;">
            <div class="stat-widget">
                <h3>By API Group (Top 10)</h3>
                <div class="chart-container">
                    <div class="stacked-bar-container">
                        {{ $colors := ColorSlice }}
                        {{ $totalGroups := 0 }}{{ range .GroupStats }}{{ $totalGroups = add $totalGroups .Count }}{{ end }}
                        {{ range $i, $stat := .GroupStats }}
                            {{ $color := index $colors (mod $i 10) }}
                            <div class="bar-segment" style="width: {{ printf "%.2f" (fdiv .Count $totalGroups | mulf 100.0) }}%; background-color: {{ $color }}; box-shadow: 0 0 10px 0px {{ $color }};" title="{{ .Name }}: {{ .Count }}"></div>
                        {{ end }}
                    </div>
                    <div class="chart-legend">
                        {{ range $i, $stat := .GroupStats }}
                        <div class="legend-item"><span class="legend-color" style="background-color: {{ index $colors (mod $i 10) }};"></span>{{ .Name }} ({{ .Count }})</div>
                        {{ end }}
                    </div>
                </div>
            </div>
            
            <div class="stat-widget"> 
                <h3>By Scope</h3>
                <div class="chart-container">
                    <div class="stacked-bar-container">
                        {{ $colors := ColorSlice }}
                        {{ $totalScope := 0 }}{{ range .ScopeStats }}{{ $totalScope = add $totalScope .Count }}{{ end }}
                        {{ range $i, $stat := .ScopeStats }}
                            {{ $color := index $colors (mod $i 10) }}
                            <div class="bar-segment" style="width: {{ printf "%.2f" (fdiv .Count $totalScope | mulf 100.0) }}%; background-color: {{ $color }}; box-shadow: 0 0 10px 0px {{ $color }};" title="{{ .Name }}: {{ .Count }}"></div>
                        {{ end }}
                    </div>
                    <div class="chart-legend">
                        {{ range $i, $stat := .ScopeStats }}
                        <div class="legend-item"><span class="legend-color" style="background-color: {{ index $colors (mod $i 10) }};"></span>{{ .Name }} ({{ .Count }})</div>
                        {{ end }}
                    </div>
                </div>
            </div>
        </div>

        {{ if .ErrorLogs }}
        <div class="errors">
            <h2>Connection Errors</h2>
            <ul>{{ range .ErrorLogs }} <li>{{ . }}</li> {{ end }}</ul>
        </div>
        {{ end }}

        <div class="search-container">
            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search by name, group, kind...">
        </div>

        <div class="container" style="margin-top: 1.5rem;">
            <table id="mainTable">
                <thead id="tableHeader">
                    <tr>
                        <th class="sortable-header col-name" data-sort-type="string">CRD Name</th>
                        <th class="sortable-header" data-sort-type="string">Kind</th>
                        <th class="sortable-header col-group" data-sort-type="string">Group</th>
                        <th class="sortable-header" data-sort-type="string">Version</th>
                        <th class="sortable-header" data-sort-type="string">Scope</th>
                        <th class="sortable-header" data-sort-type="number" data-sort-key="age">Age</th>
                        <th class="sortable-header col-cluster" data-sort-type="string">Clusters Present</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {{ range .CRDs }}
                    <tr>
                        <td class="col-name">
                            <a href="#" class="deployment-link" style="cursor: not-allowed; color: #9ca3af;" title="List View Coming Soon">
                                {{ .Name }}
                            </a>
                        </td>
                        <td><span class="strategy-tag">{{ .Kind }}</span></td>
                        <td class="col-group">{{ .Group }}</td>
                        <td>{{ .Version }}</td>
                        <td>{{ .Scope }}</td>
                        <td>{{ .Age }}</td>
                        <td class="col-clusters">
                            {{ range .Clusters }}
                            <span class="cluster-tag">{{ . }}</span>
                            {{ end }}
                        </td>
                    </tr>
                    {{ else }}
                    <tr><td colspan="7" class="no-data">No Custom Resources found.</td></tr>
                    {{ end }}
                </tbody>
            </table>
            <div class="footer">Last refreshed: {{ .LastRefreshed }}</div>
        </div>
    </main>

    <script>
        // ... (Standard Sort/Filter Scripts - Reuse from other pages) ...
        function filterTable() { let filter = document.getElementById('searchInput').value.toLowerCase(); let table = document.getElementById("mainTable"); let tr = table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"); for (let i = 0; i < tr.length; i++) { let rowText = tr[i].textContent || tr[i].innerText; if (rowText.toLowerCase().indexOf(filter) > -1) { tr[i].style.display = ""; } else { tr[i].style.display = "none"; } } }
        document.addEventListener('DOMContentLoaded', function() { const table = document.getElementById("mainTable"); const headerRow = document.getElementById("tableHeader"); const tableBody = document.getElementById("tableBody"); if (table && headerRow && tableBody) { const headers = headerRow.querySelectorAll('th.sortable-header'); headers.forEach((header, colIndex) => { header.addEventListener('click', () => { const sortType = header.dataset.sortType || 'string'; const sortKey = header.dataset.sortKey; const currentAsc = header.classList.contains('sort-asc'); const newAsc = !currentAsc; headers.forEach(h => { h.classList.remove('sort-asc', 'sort-desc'); }); if (newAsc) { header.classList.add('sort-asc'); } else { header.classList.add('sort-desc'); } sortRows(tableBody, colIndex, sortType, sortKey, newAsc); }); }); } });
        function getCellValue(row, colIndex, sortType, sortKey) { const cell = row.children[colIndex]; if (!cell) return ''; const value = (cell.firstElementChild?.textContent || cell.textContent || cell.innerText).trim(); switch (sortKey) { case 'age': let seconds = 0; if (value.endsWith('d')) { seconds = parseInt(value, 10) * 86400; } else if (value.endsWith('h')) { seconds = parseInt(value, 10) * 3600; } else if (value.endsWith('m')) { seconds = parseInt(value, 10) * 60; } else if (value.endsWith('s')) { seconds = parseInt(value, 10); } return seconds; default: if (sortType === 'number') { return parseInt(value, 10) || 0; } return value.toLowerCase(); } }
        function sortRows(tableBody, colIndex, sortType, sortKey, asc) { const rows = Array.from(tableBody.querySelectorAll('tr')); const dirModifier = asc ? 1 : -1; rows.sort((rowA, rowB) => { const valA = getCellValue(rowA, colIndex, sortType, sortKey); const valB = getCellValue(rowB, colIndex, sortType, sortKey); if (sortType === 'number') { return (valA - valB) * dirModifier; } else { return valA.localeCompare(valB) * dirModifier; } }); rows.forEach(row => { tableBody.appendChild(row); }); }
    </script>
</body>
</html>